#!/usr/bin/env node

const program = require('commander');
const pkg = require('../package.json');
const { config } = require('./cmds/config');
const { startProcess } = require('./cmds/updates');
const { getReports } = require('./cmds/reports');
const { getTask } = require('./cmds/status');
const {
  enrichJSON,
  enrichCSV,
} = require('./cmds/enrich');
const { ping } = require('./cmds/ping');

program.on('command:*', () => {
  console.error(`Invalid command: ${program.args.join(' ')}\nSee --help for a list of available commands.`);
  process.exit(1);
});

program.version(pkg.version);

program
  .command('config')
  .option('-u --url <url>', 'ezunpaywall url')
  .option('-p --port <port>', 'ezunpaywall port')
  .option('-f --file', 'show the configuration')
  .description('make the config to fetch ezunpaywall')
  .action((args) => { config(args); });

program
  .command('ping')
  .description('Check if service is available')
  .action(() => { ping(); });

program
  .command('update')
  .option('-f --file <file>', 'snapshot\'s file installed on ezunpaywall')
  .option('-l --list', 'list of snapshot installed on ezunpaywall')
  .option('-sd --startDate <starteDate>', 'start date to download and insert updates from unpaywall')
  .option('-ed --endDate <endDate>', 'end date to download and insert updates from unpaywall')
  .option('-of --offset <offset>', 'line where processing will start')
  .option('-li --limit <limit>', 'line where processing will end')
  .description('Starts an unpaywall data update process')
  .action((args) => { startProcess(args); });

program
  .command('task')
  .description('get status of processus in courses')
  .action(() => { getTask(); });

program
  .command('reports')
  .option('-f --file <file>', 'report file installed on ezunpaywall')
  .option('-l --list', 'list of reports generated by ezunpaywall')
  .option('-la --latest [latest]', 'boolean')
  .option('-s --status <status>', 'status of report, success and error only accepted')
  .description('get report')
  .action((args) => { getReports(args); });

program
  .command('enrichJSON')
  .option('-f --file <file>', 'file which must be enriched')
  .option('-a --attributes <attributes>', 'attributes which must be enriched (separeted by comma). By default, all attributes are added')
  .option('-o --out <out>', 'name of enriched file. By default, the output file is named: out.jsonl')
  .option('-v --verbose', 'logs how much lines are enriched')
  .description('enrich a json file with unpaywall attributes')
  .action((args) => { enrichJSON(args); });

program
  .command('enrichCSV')
  .option('-f --file <file>', 'file which must be enriched')
  .option('-a --attributes <attributes>', 'attributes which must be enriched (separeted by comma) By default, all attributes are added')
  .option('-s --separator <separator>', 'separator of csv out file')
  .option('-o --out <out>', 'name of enriched file')
  .option('-v --verbose', 'logs how much lines are enriched')
  .description('enrich a csv file with unpaywall attributes')
  .action((args) => { enrichCSV(args); });

program.parse(process.argv);
